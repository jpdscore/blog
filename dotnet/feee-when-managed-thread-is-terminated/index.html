<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  
  
  <title>マネージド スレッドを TerminateThread した場合に発生する .NET ランタイムの内部エラーについて | Japan Developer Support Core Team Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="こんにちは、Japan Developer Support Core チームの松井です。今回は、.NET アプリケーションでマネージド スレッドを TerminateThraed したときに発生する .NET ランタイムの内部エラーについてご案内します。 .NET ランタイムの内部エラーあるいは致命的な実行エンジン エラーは、.NET アプリケーションで発生するトラブルとしてよくお問い合わせをいた">
<meta property="og:type" content="article">
<meta property="og:title" content="マネージド スレッドを TerminateThread した場合に発生する .NET ランタイムの内部エラーについて">
<meta property="og:url" content="https://jpdscore.github.io/blog/dotnet/feee-when-managed-thread-is-terminated/index.html">
<meta property="og:site_name" content="Japan Developer Support Core Team Blog">
<meta property="og:description" content="こんにちは、Japan Developer Support Core チームの松井です。今回は、.NET アプリケーションでマネージド スレッドを TerminateThraed したときに発生する .NET ランタイムの内部エラーについてご案内します。 .NET ランタイムの内部エラーあるいは致命的な実行エンジン エラーは、.NET アプリケーションで発生するトラブルとしてよくお問い合わせをいた">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://jpdscore.github.io/blog/dotnet/feee-when-managed-thread-is-terminated/avrf1.png">
<meta property="og:image" content="https://jpdscore.github.io/blog/dotnet/feee-when-managed-thread-is-terminated/avrf2.png">
<meta property="og:image" content="https://jpdscore.github.io/blog/dotnet/feee-when-managed-thread-is-terminated/avrf3.png">
<meta property="og:image" content="https://jpdscore.github.io/blog/dotnet/feee-when-managed-thread-is-terminated/avrf4.png">
<meta property="article:published_time" content="2022-01-23T15:00:00.000Z">
<meta property="article:modified_time" content="2022-01-23T15:00:00.000Z">
<meta property="article:author" content="Developer Support Core Japan">
<meta property="article:tag" content="Debug">
<meta property="article:tag" content=".NET">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jpdscore.github.io/blog/dotnet/feee-when-managed-thread-is-terminated/avrf1.png">
  
    <link rel="alternate" href="../../blog/atom.xml" title="Japan Developer Support Core Team Blog" type="application/atom+xml">
  

  <link rel="icon" href="../../favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
  <link rel="manifest" href="../../site.webmanifest">
  <link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="theme-color" content="#ffffff">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="../../css/style.css">

<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="site-header-logo"></div>
  <div id="site-header-blog-wrapper"></div>
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        <div id="ms-logo"></div>
        
          <a class="main-nav-link" href="../../index.html">Home</a>
        
          <a class="main-nav-link" href="../../archives">Archives</a>
        
        <a class="main-nav-link" target="_blank" rel="noopener" href="https://cssjpn.github.io/">サポート情報</a>
        <a class="main-nav-link" href="/blog/general/welcome/">About</a>
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="../../blog/atom.xml" title="RSSフィード"></a>
        
      </nav>
      <div id="search-form-wrap">
        <form action="//www.bing.com/search" method="get" accept-charset="UTF-8" name="bing-search" onsubmit="var f=this;if(f['q'].value){var searchUrl =  'https://www.bing.com/search?q=' +  encodeURIComponent(f['q'].value + ' site:' + f['sitesearch'].value) ;window.open(searchUrl, 'blank') };return false;" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="検索"><button type="submit" id="nav-search-btn" class="search-form-submit"></button><input type="hidden" name="sitesearch" value="https://jpdscore.github.io/blog"></form>
      </div>
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../../index.html" id="logo">Japan Developer Support Core Team Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="../../index.html" id="subtitle">日本マイクロソフトの Japan Developer Support Core チームのブログです。</a>
        </h2>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-dotnet/feee-when-managed-thread-is-terminated" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header-single">
        
  
    <h1 class="article-title" itemprop="name">
      マネージド スレッドを TerminateThread した場合に発生する .NET ランタイムの内部エラーについて
    </h1>
  

      </header>
      <div class="article-share">
        Last Update: 
        <a href="" class="article-date-single">
  <time datetime="2022-01-23T15:00:00.000Z" itemprop="datePublished">2022-01-24</time>
</a>
        
        
        <a href="https://github.com/jpdscore/blog/issues/new?title=&body=%0A%0A---%0A%0A%23%23%23%23+Document+Details%0A%0A%E2%9A%A0+*Do+not+edit+this+section.%0A%0A*+ID%3A+5a8ae74e-22d4-578b-8322-99555f4fbc61%0A*+%E5%AF%BE%E8%B1%A1%E8%A8%98%E4%BA%8B%3A+%5B%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89+%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%92+TerminateThread+%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AB%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B+.NET+%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E3%81%AE%E5%86%85%E9%83%A8%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%5D%28https%3A%2F%2Fjpdscore.github.io%2Fblog%2Fdotnet%2Ffeee-when-managed-thread-is-terminated%2F%29" class="article-github-issue-link" target="_blank" rel="noopener noreferrer">feedback</a>
        
        <a data-url="https://jpdscore.github.io/blog/dotnet/feee-when-managed-thread-is-terminated/" data-id="cl4cg9atg001lkwordjt243a7" class="article-share-link">共有</a>
      </div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Japan Developer Support Core チームの松井です。今回は、.NET アプリケーションでマネージド スレッドを TerminateThraed したときに発生する .NET ランタイムの内部エラーについてご案内します。</p>
<p>.NET ランタイムの内部エラーあるいは致命的な実行エンジン エラーは、.NET アプリケーションで発生するトラブルとしてよくお問い合わせをいただくものの一つです。このエラーは .NET ランタイムが処理を継続できないような状況を検出した場合に発生しますが、その原因は .NET ランタイム自身の問題だけでなくアプリケーションの問題である場合もあり、トラブルシュートが難しくなる傾向があります。本記事でご案内する内容は .NET ランタイムの内部エラーを引き起こす一例ですが、問題のあるコーディングの回避や検出、トラブルシュート時の参考になれば幸いです。</p>
<h1 id="1-TerminateThread-関数について"><a href="#1-TerminateThread-関数について" class="headerlink" title="1. TerminateThread 関数について"></a>1. TerminateThread 関数について</h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread">TerminateThread 関数</a>は Win32 API の一つで、スレッドを強制的に終了させます。Remarks セクションには以下のように、対象のスレッドが何をしているのか完全に把握していて終了時に実行する可能性があるすべてのコードを制御する場合にのみ使用すべきであることが記載されています。</p>
<blockquote>
<p>TerminateThread is a dangerous function that should only be used in the most extreme cases. <span style="background-color:yellow">You should call TerminateThread only if you know exactly what the target thread is doing, and you control all of the code that the target thread could possibly be running at the time of the termination.</span> For example, TerminateThread can result in the following problems:</p>
<ul>
<li>If the target thread owns a critical section, the critical section will not be released.</li>
<li>If the target thread is allocating memory from the heap, the heap lock will not be released.</li>
<li>If the target thread is executing certain kernel32 calls when it is terminated, the kernel32 state for the thread’s process could be inconsistent.</li>
<li>If the target thread is manipulating the global state of a shared DLL, the state of the DLL could be destroyed, affecting other users of the DLL.</li>
</ul>
</blockquote>
<p>.NET アプリケーションにおいて、マネージド スレッドは .NET ランタイムによって制御されます。マネージド スレッドが破棄される場合の処理をアプリケーション開発者が制御することはできませんし、.NET ランタイムがマネージド スレッド上でどのような処理をしているのか完全に把握することもできません。つまり、マネージド スレッドを TerminateThread 関数で安全に強制終了する方法はありません。後に詳しく見ていきますが、実際に、マネージド スレッドを TerminateThread 関数で強制的に終了すると、GC の処理でアクセス違反などの問題が発生して .NET ランタイムの内部エラーによってアプリケーションが異常終了するなど予期しない動作が起こる可能性があります。</p>
<p>.NET アプリケーションの中で意図的に TerminateThread 関数でスレッドを終了するようなコードを書く方は恐らくあまりいないのではないかと思いますが、サードパーティのライブラリが内部で TerminateThread 関数を利用するケースや、アンマネージド スレッド上でマネージド コードが呼ばれている場合 (例えば COM 呼び出し可能ラッパーや C++/CLI の混合アセンブリの呼び出し) など、あるスレッドが .NET ランタイムに関連していることが分かりにくいケースもありますので注意が必要です。</p>
<h1 id="2-サンプル-コード"><a href="#2-サンプル-コード" class="headerlink" title="2. サンプル コード"></a>2. サンプル コード</h1><p>今回利用するサンプル コードは以下のとおりです。普通に終了した場合や .NET Framework の Thread.Abort メソッドを使用した場合なども比較のため含めています。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TerminateManagedThread1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Win32</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Flags</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">enum</span> ThreadAccess</span><br><span class="line">        &#123;</span><br><span class="line">            Terminate = <span class="number">0x0001</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> IntPtr InvalidHandleValue = <span class="keyword">new</span> IntPtr(<span class="number">-1</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">DllImport(<span class="meta-string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">uint</span> <span class="title">GetCurrentThreadId</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="meta-string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">OpenThread</span>(<span class="params">ThreadAccess dwDesiredAccess, <span class="built_in">bool</span> bInheritHandle, <span class="built_in">uint</span> dwThreadId</span>)</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="meta-string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">CloseHandle</span>(<span class="params">IntPtr handle</span>)</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="meta-string">&quot;kernel32.dll&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">TerminateThread</span>(<span class="params">IntPtr hThread, <span class="built_in">uint</span> dwExitCode</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> Thread _thread = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">static</span> IntPtr _threadHandle = IntPtr.Zero;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Exit normally.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> Thread(() =&gt; &#123; &#125;).Start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !NET &amp;&amp; !NETCOREAPP // .NET Core and .NET do not support Thraed.Abort.</span></span><br><span class="line">            <span class="comment">// Terminate thread by Thraed.Abort method.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> t = <span class="keyword">new</span> Thread(() =&gt; Thread.Sleep(Timeout.Infinite));</span><br><span class="line">                t.Start();</span><br><span class="line">                t.Abort();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Termiate thread by TerminateThread function.</span></span><br><span class="line">            _thread = <span class="keyword">new</span> Thread(Worker) &#123; IsBackground = <span class="literal">true</span> &#125;;</span><br><span class="line">            _thread.Start();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Press any key to terminate worker thread.&quot;</span>);</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">            <span class="keyword">if</span> (_threadHandle == IntPtr.Zero || _threadHandle == Win32.InvalidHandleValue)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Could not get worker thread handle.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Win32.TerminateThread(_threadHandle, <span class="number">0</span>);</span><br><span class="line">            Win32.CloseHandle(_threadHandle);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Press any key to exit.&quot;</span>);</span><br><span class="line">            Console.ReadKey();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// do some work to trigger GC.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> garbage = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">8192</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Never reach here...</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Exit Main method.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Worker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> tid = Win32.GetCurrentThreadId();</span><br><span class="line">            _threadHandle = (<span class="keyword">from</span> ProcessThread entry <span class="keyword">in</span> Process.GetCurrentProcess().Threads</span><br><span class="line">                             <span class="keyword">where</span> entry.Id == tid</span><br><span class="line">                             <span class="keyword">select</span> Win32.OpenThread(Win32.ThreadAccess.Terminate, <span class="literal">false</span>, tid)).FirstOrDefault();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now&#125;</span>&quot;</span>);</span><br><span class="line">                Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="3-発生する事象"><a href="#3-発生する事象" class="headerlink" title="3. 発生する事象"></a>3. 発生する事象</h1><p>マネージド スレッドを TerminateThread 関数で強制的に終了してしまった場合、.NET ランタイムは不正な状態となり予期しない動作を引き起こす可能性があります。発生する事象の例としては、不定なタイミングで発生する .NET ランタイムの内部エラーによる異常終了が挙げられます。”不定なタイミング” とは、具体的にはガベージ コレクションが実行されるタイミングです。ガベージ コレクションは .NET ランタイムがマネージド オブジェクトのメモリ割り当てで必要となったときに実行されるので、基本的に開発者がタイミングを正確に把握することはできず “不定なタイミング” で問題が顕在化することになります。このような形でアプリケーションが異常終了するとき、イベント ログには一般的に .NET Runtime と Application Error の 2 つのイベント ログが記録される場合が多いです。</p>
<h2 id="CLR-2-系-NET-Framework-3-5-SP1-以前-の場合"><a href="#CLR-2-系-NET-Framework-3-5-SP1-以前-の場合" class="headerlink" title="CLR 2 系 (.NET Framework 3.5 SP1 以前) の場合"></a>CLR 2 系 (.NET Framework 3.5 SP1 以前) の場合</h2><h3 id="NET-Runtime-イベント-ID-1023"><a href="#NET-Runtime-イベント-ID-1023" class="headerlink" title=".NET Runtime - イベント ID 1023"></a>.NET Runtime - イベント ID 1023</h3><blockquote>
<p>.NET Runtime version 2.0.50727.9151 - 致命的な実行エンジン エラーが発生しました (00007FFB8D8C6D4E) (80131506)</p>
</blockquote>
<h3 id="Application-Error-イベント-ID-1000"><a href="#Application-Error-イベント-ID-1000" class="headerlink" title="Application Error - イベント ID 1000"></a>Application Error - イベント ID 1000</h3><blockquote>
<p>障害が発生しているアプリケーション名: TerminateManagedThread1.exe、バージョン: 1.0.0.0、タイム スタンプ: 0xaf13df87<br>障害が発生しているモジュール名: mscorwks.dll、バージョン: 2.0.50727.9151、タイム スタンプ: 0x5e75a06b<br>例外コード: 0xc0000005<br>障害オフセット: 0x00000000001b2480<br>障害が発生しているプロセス ID: 0x%9<br>障害が発生しているアプリケーションの開始時刻: 0x%10<br>障害が発生しているアプリケーション パス: %11<br>障害が発生しているモジュール パス: %12<br>レポート ID: %13<br>障害が発生しているパッケージの完全な名前: %14<br>障害が発生しているパッケージに関連するアプリケーション ID: %15</p>
</blockquote>
<h2 id="CLR-4-系-NET-Framework-4-以降-の場合"><a href="#CLR-4-系-NET-Framework-4-以降-の場合" class="headerlink" title="CLR 4 系 (.NET Framework 4 以降) の場合"></a>CLR 4 系 (.NET Framework 4 以降) の場合</h2><h3 id="NET-Runtime-イベント-ID-1023-1"><a href="#NET-Runtime-イベント-ID-1023-1" class="headerlink" title=".NET Runtime - イベント ID 1023"></a>.NET Runtime - イベント ID 1023</h3><blockquote>
<p>アプリケーション:TerminateManagedThread1.exe<br>フレームワークのバージョン:v4.0.30319<br>説明: .NET ランタイムの内部エラーのため、プロセスが中止されました IP 00007FFBC6B6ABDD (00007FFBC69F0000)、終了コード 80131506。</p>
</blockquote>
<h3 id="Application-Error-イベント-ID-1000-1"><a href="#Application-Error-イベント-ID-1000-1" class="headerlink" title="Application Error - イベント ID 1000"></a>Application Error - イベント ID 1000</h3><blockquote>
<p>障害が発生しているアプリケーション名: TerminateManagedThread1.exe、バージョン: 1.0.0.0、タイム スタンプ: 0xe9f53ccf<br>障害が発生しているモジュール名: clr.dll、バージョン: 4.8.4400.0、タイム スタンプ: 0x60b90751<br>例外コード: 0xc0000005<br>障害オフセット: 0x000000000017abdd<br>障害が発生しているプロセス ID: 0x2760<br>障害が発生しているアプリケーションの開始時刻: 0x01d79b67304d0a32<br>障害が発生しているアプリケーション パス: C:\Users\user1\source\repos\TerminateManagedThread1\bin\Debug\TerminateManagedThread1.exe<br>障害が発生しているモジュール パス: C:\Windows\Microsoft.NET\Framework64\v4.0.30319\clr.dll<br>レポート ID: 6cb37b21-5ea7-4a7e-b02c-00e2cd549146<br>障害が発生しているパッケージの完全な名前:<br>障害が発生しているパッケージに関連するアプリケーション ID: </p>
</blockquote>
<h2 id="NET-Core-NET-の場合"><a href="#NET-Core-NET-の場合" class="headerlink" title=".NET Core / .NET の場合"></a>.NET Core / .NET の場合</h2><h3 id="NET-Runtime-イベント-ID-1023-2"><a href="#NET-Runtime-イベント-ID-1023-2" class="headerlink" title=".NET Runtime - イベント ID 1023"></a>.NET Runtime - イベント ID 1023</h3><blockquote>
<p>Application: ConsoleApp2.exe<br>CoreCLR Version: 5.0.921.35908<br>.NET Version: 5.0.9<br>Description: The process was terminated due to an internal error in the .NET Runtime at IP 00007FFB62A99D38 (00007FFB62980000) with exit code 80131506.</p>
</blockquote>
<h3 id="Application-Error-イベント-ID-1000-2"><a href="#Application-Error-イベント-ID-1000-2" class="headerlink" title="Application Error - イベント ID 1000"></a>Application Error - イベント ID 1000</h3><blockquote>
<p>障害が発生しているアプリケーション名: TerminateManagedThread1.exe、バージョン: 1.0.0.0、タイム スタンプ: 0x60e896d9<br>障害が発生しているモジュール名: coreclr.dll、バージョン: 5.0.921.35908、タイム スタンプ: 0x60e88dd3<br>例外コード: 0xc0000005<br>障害オフセット: 0x0000000000119d38<br>障害が発生しているプロセス ID: 0x5518<br>障害が発生しているアプリケーションの開始時刻: 0x01d79b7007b2e0d4<br>障害が発生しているアプリケーション パス: C:\Users\user1\source\repos\TerminateManagedThread1\bin\Debug\TerminateManagedThread1.exe<br>障害が発生しているモジュール パス: C:\Program Files\dotnet\shared\Microsoft.NETCore.App\5.0.9\coreclr.dll<br>レポート ID: 4ca5c8ea-b47d-42d2-8e74-b6a78e66a19d<br>障害が発生しているパッケージの完全な名前:<br>障害が発生しているパッケージに関連するアプリケーション ID: </p>
</blockquote>
<h1 id="4-デバッグ"><a href="#4-デバッグ" class="headerlink" title="4. デバッグ"></a>4. デバッグ</h1><p>Windows Error Reporting の機能でアプリケーションのクラッシュ ダンプを取得すると、以下のような状況が確認できます。</p>
<pre><code>0:000&gt; .lastevent
Last event: 2760.5434: Access violation - code c0000005 (first/second chance not available)
debugger time: Sat Aug 27 17:18:45.195 2021 (UTC + 9:00)

0:000&gt; .ecxr
rax=000000001b69ea88 rbx=00000000008fc9f0 rcx=00007ffbc71baa00
rdx=0000000000a63148 rsi=00000000008fc9f0 rdi=00000000008fc500
rip=00007ffbc6b6abdd rsp=00000000008fd270 rbp=00000000008fd370
r8=0000000000000000  r9=00007ffbc7233850 r10=0000000000000001
r11=ffffffffffadfc5b r12=0000000000000001 r13=00000000008fe760
r14=00007ffbc6afff60 r15=0000000000a630e0
iopl=0         nv up ei pl nz ac pe cy
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010211
clr!GCToEEInterface::GcScanRoots+0x143:
00007ffb`c6b6abdd 483908          cmp     qword ptr [rax],rcx ds:00000000`1b69ea88=????????????????</code></pre>
<p>以下は例外発生時のマネージド スタックです。こちらは特に異常は見られません。</p>
<pre><code>0:000&gt; !ClrStack
OS Thread Id: 0x5434 (0)
        Child SP               IP Call Site
00000000008feb78 00007ffbc6b6abdd [HelperMethodFrame: 00000000008feb78] 
00000000008feca0 00007ffb67490cc2 TerminateManagedThread1.Program.Main() [C:\Users\user1\source\repos\TerminateManagedThread1\Program.cs @ 72]
00000000008fef78 00007ffbc69f6953 [GCFrame: 00000000008fef78] </code></pre>
<p>以下は例外発生時のアンマネージド スタックです。frame 06 の clr!JIT_NewArr1 で配列のメモリ割り当てが試みられたものの、マネージド ヒープに十分なサイズがなく frame 05 で GC が実行され、その先で最終的に GC のマーク フェーズで参照元を持つオブジェクトを走査してマークしていくときの処理でアクセス違反が発生していたことが確認できます。</p>
<pre><code>0:000&gt; knL
# Child-SP          RetAddr               Call Site
00 00000000`008fd270 00007ffb`c6b02018     clr!GCToEEInterface::GcScanRoots+0x143
01 00000000`008fe730 00007ffb`c6b02b5f     clr!WKS::gc_heap::mark_phase+0x17f
02 00000000`008fe7d0 00007ffb`c6b02a73     clr!WKS::gc_heap::gc1+0xf1
03 00000000`008fe820 00007ffb`c6b04a67     clr!WKS::gc_heap::garbage_collect+0x193
04 00000000`008fe860 00007ffb`c6b06cb7     clr!WKS::GCHeap::GarbageCollectGeneration+0xef
05 00000000`008fe8b0 00007ffb`c6a20226     clr!WKS::GCHeap::Alloc+0x29c
06 00000000`008fe900 00007ffb`67490cc2     clr!JIT_NewArr1+0x6be
07 00000000`008feca0 00007ffb`c69f6953     0x00007ffb`67490cc2
08 00000000`008fed90 00007ffb`c69f6858     clr!CallDescrWorkerInternal+0x83
09 00000000`008fedd0 00007ffb`c69f7118     clr!CallDescrWorkerWithHandler+0x4e
0a 00000000`008fee10 00007ffb`c6b32280     clr!MethodDescCallSite::CallTargetWorker+0x102
0b 00000000`008fef10 00007ffb`c6b32b27     clr!RunMain+0x25f
0c 00000000`008ff0f0 00007ffb`c6b329db     clr!Assembly::ExecuteMainMethod+0xb7
0d 00000000`008ff3e0 00007ffb`c6b32324     clr!SystemDomain::ExecuteMainMethod+0x643
0e 00000000`008ff9e0 00007ffb`c6b3207d     clr!ExecuteEXE+0x3f
0f 00000000`008ffa50 00007ffb`c6b33264     clr!_CorExeMainInternal+0xb2
10 00000000`008ffae0 00007ffb`c8dd8c01     clr!CorExeMain+0x14
11 00000000`008ffb20 00007ffb`c8faac42     mscoreei!CorExeMain+0x112
12 00000000`008ffb80 00007ffb`d7287034     mscoree!CorExeMain_Exported+0x72
13 00000000`008ffbb0 00007ffb`d7fc2651     kernel32!BaseThreadInitThunk+0x14
14 00000000`008ffbe0 00000000`00000000     ntdll!RtlUserThreadStart+0x21</code></pre>
<p>マネージド スレッドの状態を確認すると以下のようになっています。特徴的な点として、ハイライトしている TerminateThread 関数で終了されたスレッドはアンマネージド スレッドの番号が XXXX で OSID が 0 以外 (以下の例では 3330) になっていることが挙げられます。TerminateThread 関数でマネージド スレッドが終了された場合、.NET ランタイムはスレッドが終了されたことを知ることができないのでマネージド スレッドはまだ管理対象になっており sos デバッガー拡張はマネージド スレッドを列挙しますが、スレッドはすでに終了しているためダンプ ファイル内のアンマネージド スレッドに関連づけることができず XXXX になります。ただしマネージド スレッドのクリーンアップはされていないため OSThreadID は残ったままになっています。正常に終了したスレッドや Thread.Abort メソッドで強制終了されたスレッドは OSThreadID がクリアされるため OSID が 0 になっています。</p>
<pre><code>0:000&gt; .loadby sos.dll clr

0:000&gt; !sos.threads
ThreadCount:      8
UnstartedThread:  0
BackgroundThread: 2
PendingThread:    0
DeadThread:       5
Hosted Runtime:   no
                                                                                                        Lock  
    ID OSID ThreadOBJ           State GC Mode     GC Alloc Context                  Domain           Count Apt Exception
0    1 5434 0000000000a06b30    2a020 Preemptive  0000000000000000:0000000000000000 00000000009fb820 0     MTA (GC) System.ExecutionEngineException 0000000002de1228
5    2 6164 0000000000a34940    2b220 Preemptive  0000000000000000:0000000000000000 00000000009fb820 0     MTA (Finalizer) 
XXXX 3    0 0000000000a5aa30    39820 Preemptive  0000000000000000:0000000000000000 00000000009fb820 0     Ukn 
XXXX 4    0 0000000000a5ce80    39820 Preemptive  0000000000000000:0000000000000000 00000000009fb820 0     Ukn 
XXXX 5    0 0000000000a5db30   839820 Preemptive  0000000000000000:0000000000000000 00000000009fb820 0     Ukn 
XXXX 6    0 0000000000a61780   839820 Preemptive  0000000000000000:0000000000000000 00000000009fb820 0     Ukn 
XXXX 7    0 0000000000a62430   839820 Preemptive  0000000000000000:0000000000000000 00000000009fb820 0     Ukn 
<span style="background-color:darkcyan">XXXX 8 3330 0000000000a630e0  202b220 Preemptive  0000000000000000:0000000000000000 00000000009fb820 0     Ukn</span> </code></pre>
<h1 id="5-実装の確認"><a href="#5-実装の確認" class="headerlink" title="5. 実装の確認"></a>5. 実装の確認</h1><p>何故 TerminateThread 関数でスレッドを強制終了するとこのような状態になってしまうのか、エラーが発生した箇所周辺の .NET ランタイムの実装を見ていきます。今回もソースコードを確認するため .NET でビルドしなおします。コールスタックは以下のとおりです。</p>
<pre><code>0:000&gt; k
# Child-SP          RetAddr               Call Site
00 (Inline Function) --------`--------     coreclr!ScanStackRoots+0xec [D:\workspace\_work\1\s\src\coreclr\src\vm\gcenv.ee.cpp @ 100] 
01 (Inline Function) --------`--------     coreclr!GCToEEInterface::GcScanRoots+0x11d [D:\workspace\_work\1\s\src\coreclr\src\vm\gcenv.ee.cpp @ 233] 
02 (Inline Function) --------`--------     coreclr!GCScan::GcScanRoots+0x11d [D:\workspace\_work\1\s\src\coreclr\src\gc\gcscan.cpp @ 154] 
03 000000bb`d217c6b0 00007ffb`776a8553     coreclr!WKS::gc_heap::mark_phase+0x4d8 [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 20753] 
04 000000bb`d217dca0 00007ffb`776a76a7     coreclr!WKS::gc_heap::gc1+0x1c3 [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 16694] 
05 (Inline Function) --------`--------     coreclr!GCToOSInterface::GetLowPrecisionTimeStamp+0x5 [D:\workspace\_work\1\s\src\coreclr\src\vm\gcenv.os.cpp @ 1033] 
06 000000bb`d217dd70 00007ffb`77677486     coreclr!WKS::gc_heap::garbage_collect+0xa67 [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 18280] 
07 000000bb`d217de50 00007ffb`776b5f45     coreclr!WKS::GCHeap::GarbageCollectGeneration+0x256 [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 37751] 
08 (Inline Function) --------`--------     coreclr!WKS::gc_heap::trigger_gc_for_alloc+0x19b [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 13862] 
09 (Inline Function) --------`--------     coreclr!WKS::gc_heap::try_allocate_more_space+0x1a2 [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 13985] 
0a 000000bb`d217dee0 00007ffb`7766fcf7     coreclr!WKS::gc_heap::allocate_more_space+0x1c5 [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 14486] 
0b (Inline Function) --------`--------     coreclr!WKS::gc_heap::allocate+0x5a [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 14517] 
0c 000000bb`d217df60 00007ffb`775c942c     coreclr!WKS::GCHeap::Alloc+0x87 [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 36745] 
0d (Inline Function) --------`--------     coreclr!Alloc+0xbd [D:\workspace\_work\1\s\src\coreclr\src\vm\gchelpers.cpp @ 228] 
0e (Inline Function) --------`--------     coreclr!AllocateSzArray+0x17f [D:\workspace\_work\1\s\src\coreclr\src\vm\gchelpers.cpp @ 483] 
0f 000000bb`d217dfd0 00007ffb`17b66234     coreclr!JIT_NewArr1+0x28c [D:\workspace\_work\1\s\src\coreclr\src\vm\jithelpers.cpp @ 2723] 
10 000000bb`d217e2a0 00007ffb`776d9d13     0x00007ffb`17b66234
...</code></pre>
<p>GitHub から当該バージョンのソースコードの URL を得るためにコミット ID を確認しておきます。</p>
<pre><code>0:000&gt; lmvmcoreclr
Browse full module list
start             end                 module name
00007ffb`63d10000 00007ffb`6421f000   coreclr    (private pdb symbols)  C:\ProgramData\Dbg\sym\coreclr.pdb\8ECEA313239E429385FAAFD93CF2AF161\coreclr.pdb
    Loaded symbol image file: coreclr.dll
    Image path: C:\Program Files\dotnet\shared\Microsoft.NETCore.App\5.0.9\coreclr.dll
    Image name: coreclr.dll
    Browse all global symbols  functions  data
    Timestamp:        Sat Jul 10 02:56:35 2021 (60E88DD3)
    CheckSum:         004FD1FE
    ImageSize:        0050F000
    File version:     5.0.921.35908
    Product version:  5.0.921.35908
    File flags:       0 (Mask 3F)
    File OS:          4 Unknown Win32
    File type:        0.0 Unknown
    File date:        00000000.00000000
    Translations:     0409.04b0
    Information from resource tables:
        CompanyName:      Microsoft Corporation
        ProductName:      Microsoft® .NET
        InternalName:     CoreCLR.dll
        OriginalFilename: CoreCLR.dll
        ProductVersion:   5,0,921,35908 @Commit: <span style="background-color:darkmagenta">208e377a5329ad6eb1db5e5fb9d4590fa50beadd</span>
        FileVersion:      5,0,921,35908 @Commit: <span style="background-color:darkmagenta">208e377a5329ad6eb1db5e5fb9d4590fa50beadd</span>
        FileDescription:  Microsoft .NET Runtime
        LegalCopyright:   © Microsoft Corporation. All rights reserved.
        Comments:         Flavor=Retail</code></pre>
<p>例外が発生した frame 00 を確認します。コミット ID とコール スタックのソース パス、リポジトリの場所から URL は <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/blob/208e377a5329ad6eb1db5e5fb9d4590fa50beadd/src/coreclr/src/vm/gcenv.ee.cpp">https://github.com/dotnet/runtime/blob/208e377a5329ad6eb1db5e5fb9d4590fa50beadd/src/coreclr/src/vm/gcenv.ee.cpp</a> になります。</p>
<figure class="highlight cs"><figcaption><span>src/coreclr/src/vm/gcenv.ee.cpp</span><a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/blob/208e377a5329ad6eb1db5e5fb9d4590fa50beadd/src/coreclr/src/vm/gcenv.ee.cpp#L100">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ScanStackRoots</span>(<span class="params">Thread * pThread, promote_func* fn, ScanContext* sc</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GCCONTEXT   gcctx;</span><br><span class="line"></span><br><span class="line">    gcctx.f  = fn;</span><br><span class="line">    gcctx.sc = sc;</span><br><span class="line">    gcctx.cf = NULL;</span><br><span class="line"></span><br><span class="line">    ENABLE_FORBID_GC_LOADER_USE_IN_THIS_SCOPE();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Either we are in a concurrent situation (in which case the thread is unknown to</span></span><br><span class="line">    <span class="comment">// us), or we are performing a synchronous GC and we are the GC thread, holding</span></span><br><span class="line">    <span class="comment">// the threadstore lock.</span></span><br><span class="line"></span><br><span class="line">    _ASSERTE(dbgOnly_IsSpecialEEThread() ||</span><br><span class="line">                GetThread() == NULL ||</span><br><span class="line">                <span class="comment">// this is for background GC threads which always call this when EE is suspended.</span></span><br><span class="line">                IsGCSpecialThread() ||</span><br><span class="line">                (GetThread() == ThreadSuspend::GetSuspensionThread() &amp;&amp; ThreadStore::HoldingThreadStore()));</span><br><span class="line"></span><br><span class="line">    Frame* pTopFrame = pThread-&gt;GetFrame();</span><br><span class="line">    Object ** topStack = (Object **)pTopFrame;</span><br><span class="line">    <span class="keyword">if</span> ((pTopFrame != ((Frame*)<span class="number">-1</span>))</span><br><span class="line">        &amp;&amp; (pTopFrame-&gt;GetVTablePtr() == InlinedCallFrame::GetMethodFrameVPtr())) &#123;</span><br><span class="line">        <span class="comment">// It is an InlinedCallFrame. Get SP from it.</span></span><br><span class="line">        InlinedCallFrame* pInlinedFrame = (InlinedCallFrame*)pTopFrame;</span><br><span class="line">        topStack = (Object **)pInlinedFrame-&gt;GetCallSiteSP();</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例外発生時のコンテキストとそこから遡った命令の状況から、エラーが発生した処理は <code>pTopFrame-&gt;GetVTablePtr() == InlinedCallFrame::GetMethodFrameVPtr()</code> の箇所における pTopFrame ポインターのメンバー参照であったことが分かります。</p>
<pre><code>0:000&gt; r
rax=00007ffb779b4bf0 rbx=0000000000000002 rcx=0000024813443150
rdx=00000248153e5fd8 rsi=000000bbd2c3ef98 rdi=00000248153e5f80
rip=00007ffb776a9d38 rsp=000000bbd217c6b0 rbp=000000bbd217c7b0
r8=0000000000000000  r9=000000007ffe4000 r10=00000fff6eedb0d0
r11=5141555511551055 r12=0000000000000000 r13=00000248153e5f80
r14=0000024815386b30 r15=00007ffb775add50
iopl=0         nv up ei pl nz ac po cy
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010217
coreclr!ScanStackRoots+0xec [inlined in coreclr!WKS::gc_heap::mark_phase+0x4d8]:
00007ffb`776a9d38 483906          cmp     qword ptr [rsi],rax ds:000000bb`d2c3ef98=????????????????

0:000&gt; ub
coreclr!ScanStackRoots+0xca [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 20753] [inlined in coreclr!WKS::gc_heap::mark_phase+0x4b6 [D:\workspace\_work\1\s\src\coreclr\src\gc\gc.cpp @ 20753]]:
00007ffb`776a9d16 4c897d48        mov     qword ptr [rbp+48h],r15
00007ffb`776a9d1a 488d442478      lea     rax,[rsp+78h]
00007ffb`776a9d1f 48894550        mov     qword ptr [rbp+50h],rax
00007ffb`776a9d23 4c896558        mov     qword ptr [rbp+58h],r12
00007ffb`776a9d27 488b7610        mov     rsi,qword ptr [rsi+10h]
00007ffb`776a9d2b 4883feff        cmp     rsi,0FFFFFFFFFFFFFFFFh
00007ffb`776a9d2f 7410            je      coreclr!WKS::gc_heap::mark_phase+0x4e1 (00007ffb`776a9d41)
00007ffb`776a9d31 488d05b8ae3000  lea     rax,[coreclr!InlinedCallFrame::`vftable&#39; (00007ffb`779b4bf0)]</code></pre>
<p>ソースコードを確認すると pTopFrame は現在の処理対象であるスレッドを指す pThread から取得されているので、ScanContext から現在の処理対象のスレッドを確認します。</p>
<pre><code>0:000&gt; dx @$curframe.LocalVariables.gcctx.sc-&gt;thread_under_crawl-&gt;m_OSThreadId
@$curframe.LocalVariables.gcctx.sc-&gt;thread_under_crawl-&gt;m_OSThreadId : <span style="background-color:darkblue">0x3290</span> [Type: unsigned __int64

0:000&gt; !sos.threads
ThreadCount:      7
UnstartedThread:  0
BackgroundThread: 4
PendingThread:    0
DeadThread:       2
Hosted Runtime:   no
                                                                                                            Lock  
DBG   ID     OSID ThreadOBJ           State GC Mode     GC Alloc Context                  Domain           Count Apt Exception
0    1     7090 0000024813458490    2a020 Cooperative 0000000000000000:0000000000000000 000002481344eb30 -00001 MTA (GC) 
6    2     3970 000002481345EE60    2b220 Preemptive  0000000000000000:0000000000000000 000002481344eb30 -00001 MTA (Finalizer) 
7    3     18d0 00000248153973E0  102a220 Preemptive  0000000000000000:0000000000000000 000002481344eb30 -00001 MTA (Threadpool Worker) 
XXXX 4        0 00000248153E5090    39820 Preemptive  0000000000000000:0000000000000000 000002481344eb30 -00001 Ukn 
XXXX 5        0 00000248153E6E30    <span style="background-color:darkgoldenrod">39820</span> Preemptive  0000000000000000:0000000000000000 000002481344eb30 -00001 Ukn 
XXXX 6     <span style="background-color:darkblue">3290</span> 00000248153E5F80  <span style="background-color:darkgoldenrod">202b220</span> Preemptive  0000000000000000:0000000000000000 000002481344eb30 -00001 Ukn 
9    7     6890 00000248154434C0  1029220 Preemptive  0000000000000000:0000000000000000 000002481344eb30 -00001 MTA (Threadpool Worker) </code></pre>
<p>OSThreadID フィールドの値から当該スレッドのコールスタックの確認を試みますが、既に終了しておりスレッドが存在しないためエラーになります。</p>
<pre><code>0:000&gt; ~~[<span style="background-color:darkblue">0x3290</span>]k
            ^ Illegal thread error in &#39;~~[0x3290]k&#39;</code></pre>
<p>例外は存在しないスレッドのデータ構造への参照を試みたことにより発生しています。サンプル プログラムのように TerminateThread 関数でマネージド スレッドを終了させた場合、.NET ランタイムのスレッドの<a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/blob/208e377a5329ad6eb1db5e5fb9d4590fa50beadd/src/coreclr/src/vm/threads.cpp#L2878">クリーンアップ処理</a>が呼ばれないままスレッドがなくなるため、GC でオブジェクトを走査する際にこのような問題が発生します。正常に終了したスレッドと TerminateThraed 関数で終了したスレッドの ThreadState の状態を比較しても、後者は <u>“Dead”</u> や <u>“Reported Dead”</u> のフラグがなく終了した扱いになっていないことが分かります。</p>
<pre><code>0:000&gt; !ThreadState <span style="background-color:darkgoldenrod">39820</span>
    Legal to Join
    <u>Dead</u>
    CLR Owns
    In Multi Threaded Apartment
    <u>Reported Dead</u>
    Fully initialized

0:000&gt; !ThreadState <span style="background-color:darkgoldenrod">202b220</span>
    Legal to Join
    Background
    CLR Owns
    CoInitialized
    In Multi Threaded Apartment
    Fully initialized
    Interruptible</code></pre>
<h1 id="6-TerminateThread-関数でスレッドを終了させた箇所の調査"><a href="#6-TerminateThread-関数でスレッドを終了させた箇所の調査" class="headerlink" title="6. TerminateThread 関数でスレッドを終了させた箇所の調査"></a>6. TerminateThread 関数でスレッドを終了させた箇所の調査</h1><p>常にデバッガーの元でアプリケーションを実行できるのであれば、kernel32!TerminateThread にブレークポイントを設定しておけば誰が TerminateThread 関数でスレッドを終了させたか確認できます。これが難しい場合は、<a target="_blank" rel="noopener" href="https://developer.microsoft.com/ja-jp/windows/downloads/windows-sdk/">Windows SDK</a> に含まれる Application Verifier の機能を利用することで TerminateThread 関数が呼び出されたときにアプリケーションを終了させてダンプ ファイルを取得し、TerminateThread 関数の呼び出し元を調査することが可能です。</p>
<ol>
<li><p><a href="/blog/debugging/using-WER/">Windows Error Reporting</a> などの機能で、アプリケーションの異常終了時にダンプ ファイルを出力する設定を行います。</p>
</li>
<li><p>スタート メニューから Application Verifier を起動します。</p>
</li>
<li><p>Application Verifier のメニューから [Add Application] を選択し、ダイアログで対象のアプリケーションを選択します。<img src="avrf1.png"></p>
</li>
<li><p>左側のリストに追加されたアプリケーションを選択し、右側のツリーで [Miscellaneous] - [DangerousAPIs] のみにチェックを入れた状態で、項目を右クリックしてメニューから [Verifier Stop Options] を選択します。<img src="avrf2.png"></p>
</li>
<li><p>左側のリストで [00000100] を選択し、[Error Reporting] 欄で “Breakpoint”、[Miscellaneous] 欄で “Not Continuable” が選択されていることを確認し、OK ボタンを押下します。(00000100 以外にも様々な項目がありますが、不要であれば Inactive にチェックを入れて無効にして構いません。)<img src="avrf3.png"></p>
</li>
<li><p>[Save] ボタンを押下して設定を反映します。<img src="avrf4.png"></p>
</li>
<li><p>アプリケーションを再起動して事象を再現させます。再現したらアプリケーションが終了してダンプ ファイルが出力されます。</p>
</li>
</ol>
<p>ダンプ ファイルが出力されたら、!ClrStack コマンドや k コマンドなどでコール スタックを確認し、TerminateThread 関数を呼び出した処理を特定できます。アンマネージド スタックを確認すると、vfbasics や frfcore など Application Verifier の処理が挿入されていることも分かります。</p>
<pre><code>0:000&gt; !ClrStack
OS Thread Id: 0x29f4 (0)
        Child SP               IP Call Site
000000DF38F7E640 00007ffbd800d974 [InlinedCallFrame: 000000df38f7e640] TerminateManagedThread1.Win32.TerminateThread(IntPtr, UInt32)
000000DF38F7E640 00007ffb17bb57ef [InlinedCallFrame: 000000df38f7e640] TerminateManagedThread1.Win32.TerminateThread(IntPtr, UInt32)
000000DF38F7E610 00007ffb17bb57ef ILStubClass.IL_STUB_PInvoke(IntPtr, UInt32)
000000DF38F7E6D0 00007ffb17ba61d2 TerminateManagedThread1.Program.Main() [C:\Users\user1\source\repos\TerminateManagedThread1\Program.cs @ 65]

0:000&gt; k
# Child-SP          RetAddr               Call Site
00 000000df`38f7d028 00007ffb`d804dc48     ntdll!NtWaitForMultipleObjects+0x14
01 000000df`38f7d030 00007ffb`d804d22e     ntdll!WerpWaitForCrashReporting+0xa8
02 000000df`38f7d0b0 00007ffb`d804c9eb     ntdll!RtlReportExceptionHelper+0x33e
03 000000df`38f7d180 00007ffb`93782ca0     ntdll!RtlReportException+0x9b
04 000000df`38f7d200 00007ffb`d7fe8a4c     <span style="background-color:darkcyan">vfbasics!AVrfpVectoredExceptionHandler+0xf0</span>
05 000000df`38f7d250 00007ffb`d7fc1276     ntdll!RtlpCallVectoredHandlers+0x108
06 000000df`38f7d2f0 00007ffb`d8010cae     ntdll!RtlDispatchException+0x66
07 000000df`38f7d500 00007ffb`957226e6     ntdll!KiUserExceptionDispatch+0x2e
08 000000df`38f7e250 00007ffb`93796733     <span style="background-color:darkcyan">vrfcore!VerifierStopMessageEx+0x806</span>
09 000000df`38f7e5b0 00007ffb`17bb57ef     <span style="background-color:darkcyan">vfbasics!AVrfpTerminateThread+0x103</span>
0a 000000df`38f7e610 00007ffb`17ba61d2     0x00007ffb`17bb57ef
0b 000000df`38f7e6d0 00007ffb`77729d13     0x00007ffb`17ba61d2
0c 000000df`38f7e7a0 00007ffb`77615e7a     coreclr!CallDescrWorkerInternal+0x83 [D:\workspace\_work\1\s\src\coreclr\src\vm\amd64\CallDescrWorkerAMD64.asm @ 100] 
0d 000000df`38f7e7e0 00007ffb`776101ff     coreclr!MethodDescCallSite::CallTargetWorker+0x3d2 [D:\workspace\_work\1\s\src\coreclr\src\vm\callhelpers.cpp @ 552] 
0e (Inline Function) --------`--------     coreclr!MethodDescCallSite::Call+0xb [D:\workspace\_work\1\s\src\coreclr\src\vm\callhelpers.h @ 458] 
0f 000000df`38f7e970 00007ffb`7760ffca     coreclr!RunMainInternal+0x11f [D:\workspace\_work\1\s\src\coreclr\src\vm\assembly.cpp @ 1465] 
10 000000df`38f7eaa0 00007ffb`7760fd29     coreclr!RunMain+0xd2 [D:\workspace\_work\1\s\src\coreclr\src\vm\assembly.cpp @ 1536] 
11 000000df`38f7eb50 00007ffb`77610688     coreclr!Assembly::ExecuteMainMethod+0x1cd [D:\workspace\_work\1\s\src\coreclr\src\vm\assembly.cpp @ 1648] 
12 000000df`38f7eee0 00007ffb`776056a2     coreclr!CorHost2::ExecuteAssembly+0x1c8 [D:\workspace\_work\1\s\src\coreclr\src\vm\corhost.cpp @ 384] 
13 000000df`38f7f050 00007ffb`7cfc2993     coreclr!coreclr_execute_assembly+0xe2 [D:\workspace\_work\1\s\src\coreclr\src\dlls\mscoree\unixinterface.cpp @ 431] 
14 (Inline Function) --------`--------     hostpolicy!coreclr_t::execute_assembly+0x27 [D:\workspace\_work\1\s\src\installer\corehost\cli\hostpolicy\coreclr.cpp @ 89] 
15 000000df`38f7f0f0 00007ffb`7cfc2c07     hostpolicy!run_app_for_context+0x3d3 [D:\workspace\_work\1\s\src\installer\corehost\cli\hostpolicy\hostpolicy.cpp @ 246] 
16 000000df`38f7f280 00007ffb`7cfc354e     hostpolicy!run_app+0x37 [D:\workspace\_work\1\s\src\installer\corehost\cli\hostpolicy\hostpolicy.cpp @ 275] 
17 000000df`38f7f2c0 00007ffb`8573bf58     hostpolicy!corehost_main+0xfe [D:\workspace\_work\1\s\src\installer\corehost\cli\hostpolicy\hostpolicy.cpp @ 408] 
18 000000df`38f7f470 00007ffb`8573ec97     hostfxr!execute_app+0x2e8 [D:\workspace\_work\1\s\src\native\corehost\fxr\fx_muxer.cpp @ 146] 
19 000000df`38f7f570 00007ffb`85740fc2     hostfxr!`anonymous namespace&#39;::read_config_and_execute+0x97 [D:\workspace\_work\1\s\src\native\corehost\fxr\fx_muxer.cpp @ 520] 
1a 000000df`38f7f670 00007ffb`8573f2ed     hostfxr!fx_muxer_t::handle_exec_host_command+0x152 [D:\workspace\_work\1\s\src\native\corehost\fxr\fx_muxer.cpp @ 1001] 
1b 000000df`38f7f710 00007ffb`85738ceb     hostfxr!fx_muxer_t::execute+0x47d [D:\workspace\_work\1\s\src\native\corehost\fxr\fx_muxer.cpp @ 566] 
1c 000000df`38f7f850 00007ff7`aa4cdc1c     hostfxr!hostfxr_main_startupinfo+0xab [D:\workspace\_work\1\s\src\native\corehost\fxr\hostfxr.cpp @ 61] 
1d 000000df`38f7f950 00007ff7`aa4cdf81     TerminateManagedThread1_exe!exe_start+0x604 [D:\workspace\_work\1\s\src\installer\corehost\corehost.cpp @ 236] 
1e 000000df`38f7fb40 00007ff7`aa4cf4f8     TerminateManagedThread1_exe!wmain+0x129 [D:\workspace\_work\1\s\src\installer\corehost\corehost.cpp @ 302] 
1f (Inline Function) --------`--------     TerminateManagedThread1_exe!invoke_main+0x22 [d:\agent\_work\4\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl @ 90] 
20 000000df`38f7fcb0 00007ffb`d7287034     TerminateManagedThread1_exe!__scrt_common_main_seh+0x10c [d:\agent\_work\4\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl @ 288] 
21 000000df`38f7fcf0 00007ffb`d7fc2651     kernel32!BaseThreadInitThunk+0x14
22 000000df`38f7fd20 00000000`00000000     ntdll!RtlUserThreadStart+0x21</code></pre>
<p>なお、うまくいかない場合はタスク マネージャーなどでプロセスの実行中の状態でダンプ ファイルを取得し、!gflag コマンドや !avrf コマンドで Application Verifier が有効になっているかどうか確認してください。Application Verifier が有効になっている場合は、!gflag コマンドで Enable application verifier が表示されます。</p>
<pre><code>0:000&gt; !gflag
Current NtGlobalFlag contents: 0x00000100
    vrf - Enable application verifier</code></pre>
<p>また、!avrf コマンドで DangerousAPIs の Verifier が有効になっていることが確認できます。</p>
<pre><code>0:000&gt; !avrf
Verifier package version &gt;= 3.00 
Application verifier settings (80000200):

- no heap checking enabled!
- DangerousAPIs

No verifier stop active.

Note. Sometimes bugs found by verifier manifest themselves
as raised exceptions (access violations, stack overflows, invalid handles
and it is not always necessary to have a verifier stop.</code></pre>
<h1 id="7-まとめ"><a href="#7-まとめ" class="headerlink" title="7. まとめ"></a>7. まとめ</h1><p>マネージド スレッドを TerminateThread 関数で終了させてしまうと、.NET ランタイムが管理しているマネージド スレッドの状態に問題が生じてアプリケーションが不定なタイミングで異常終了する可能性があります。アプリケーションのクラッシュ ダンプ ファイルを取得して !sos.threads コマンドによるスレッドの状態を確認した際に、アンマネージ スレッドの番号 が XXXX かつ OSID が 0 以外のスレッドが見られる場合はこの問題に該当する可能性があります。この場合ダンプ ファイルのみからスレッドが終了された原因を特定することは困難なため、デバッガーや Application Verifier の構成の元で事象を再現させて調査を行う必要があります。本記事が TerminateThread 関数を使用した場合に懸念される副作用の理解や問題が生じた際のトラブルシュート方法の参考になれば幸いです。</p>

      
      
        <div class="article-disclaimer">
        
          <p><hr>本ブログの内容は弊社の公式見解として保証されるものではなく、開発・運用時の参考情報としてご活用いただくことを目的としています。もし公式な見解が必要な場合は、弊社ドキュメント (<a target="_blank" rel="noopener" href="https://docs.microsoft.com/">https://docs.microsoft.com</a> や <a target="_blank" rel="noopener" href="https://support.microsoft.com">https://support.microsoft.com</a>) をご参照いただくか、もしくは私共サポートまでお問い合わせください。</p>
        
        </div>
      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/NET/" rel="tag">.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Debug/" rel="tag">Debug</a></li></ul>

      <!-- 
      
        <a href="https://github.com/jpdscore/blog/edit/master/articles/dotnet/feee-when-managed-thread-is-terminated.md" class="article-github-edit-link" target="_blank" rel="noopener noreferrer">GitHub で編集</a>
        
      -->
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../feee-managed-heap-corruption/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">次の記事</strong>
      <div class="article-nav-title">
        
          マネージド ヒープの破損により発生する GC 中の .NET ランタイムの内部エラーについて
        
      </div>
    </a>
  
  
    <a href="../../vscode/devcontainer_intro/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前の記事</strong>
      <div class="article-nav-title">Devcontainerを利用した自動環境構築</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最近の投稿</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../../azuredevops/DevOpsPricing/">Azure DevOps Services の料金体系をおさらいしてみよう！</a>
          </li>
        
          <li>
            <a href="../../vs/vs2013-signin-error/">Visual Studio 2013 でサインイン画面が表示されない場合の対処方法について</a>
          </li>
        
          <li>
            <a href="../../azuredevops/devops-log-collection/">Azure DevOps Services トラブルシューティング用のデータ採取について</a>
          </li>
        
          <li>
            <a href="../../azuredevops/pipelines-agents-ip-settings/">Azure Pipelines エージェントの IP について</a>
          </li>
        
          <li>
            <a href="../../azuredevops/deprecating-weak-cryptographic-standards-tls-1-0-and-tls-1-1-in-azure-devops/">Azure DevOps Services における弱い暗号化標準 (TLS 1.0 および TLS 1.1) の廃止について</a>
          </li>
        
          <li>
            <a href="../../azuredevops/pipelines-log-collection/">Azure Pipelines のトラブルシューティング用データ採取について</a>
          </li>
        
          <li>
            <a href="../feee-managed-heap-corruption/">マネージド ヒープの破損により発生する GC 中の .NET ランタイムの内部エラーについて</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグ</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../../tags/ALM/">ALM</a><span class="tag-list-count">9</span><ul><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/ALM/Azure-DevOps-Services">Azure DevOps Services</a><span class="tag-list-count">3</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/ALM/Azure-Pipelines">Azure Pipelines</a><span class="tag-list-count">5</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/ALM/Azure-Repos">Azure Repos</a><span class="tag-list-count">1</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/ALM/Devcontainer">Devcontainer</a><span class="tag-list-count">1</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/ALM/GitHub">GitHub</a><span class="tag-list-count">1</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/ALM/Visual-Studio-Code">Visual Studio Code</a><span class="tag-list-count">1</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/ALM/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96%E6%89%8B%E9%A0%86">情報採取手順</a><span class="tag-list-count">2</span></li></ul></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96%E6%89%8B%E9%A0%86/">情報採取手順</a><span class="tag-list-count">3</span><ul><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96%E6%89%8B%E9%A0%86/ALM">ALM</a><span class="tag-list-count">2</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96%E6%89%8B%E9%A0%86/Azure-DevOps-Services">Azure DevOps Services</a><span class="tag-list-count">1</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96%E6%89%8B%E9%A0%86/Azure-Pipelines">Azure Pipelines</a><span class="tag-list-count">1</span></li></ul></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Windows-SDK/">Windows SDK</a><span class="tag-list-count">6</span><ul><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Windows-SDK/Debug">Debug</a><span class="tag-list-count">5</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Windows-SDK/GDI">GDI</a><span class="tag-list-count">1</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Windows-SDK/Leak">Leak</a><span class="tag-list-count">1</span></li></ul></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Debug/">Debug</a><span class="tag-list-count">12</span><ul><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Debug/NET">.NET</a><span class="tag-list-count">3</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Debug/Leak">Leak</a><span class="tag-list-count">1</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Debug/Memory">Memory</a><span class="tag-list-count">1</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Debug/Windows-SDK">Windows SDK</a><span class="tag-list-count">5</span></li></ul></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Deployment/">Deployment</a><span class="tag-list-count">2</span><ul><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Deployment/ClickOnce">ClickOnce</a><span class="tag-list-count">2</span></li></ul></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/NET/">.NET</a><span class="tag-list-count">6</span><ul><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/NET/NET-Framework">.NET Framework</a><span class="tag-list-count">3</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/NET/Debug">Debug</a><span class="tag-list-count">3</span></li></ul></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/%E5%85%A8%E8%88%AC/">全般</a><span class="tag-list-count">1</span><ul></ul></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Visual-Studio/">Visual Studio</a><span class="tag-list-count">5</span><ul><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Visual-Studio/C">C#</a><span class="tag-list-count">2</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Visual-Studio/C">C++</a><span class="tag-list-count">3</span></li><li class="tag-list-item tag-list-item-child-tag"><a class="tag-list-link tag-list-link-child" href="../../tags/Visual-Studio/VB-NET">VB.NET</a><span class="tag-list-count">2</span></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2022/06/">2022 / 06</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2022/04/">2022 / 04</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2022/03/">2022 / 03</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2022/01/">2022 / 01</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2021/12/">2021 / 12</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2021/08/">2021 / 08</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2021/05/">2021 / 05</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2021/04/">2021 / 04</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2021/02/">2021 / 02</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2021/01/">2021 / 01</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2020/12/">2020 / 12</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2020/11/">2020 / 11</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2020/10/">2020 / 10</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2020/09/">2020 / 09</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


  
    <div class="widget-wrap">
  <h3 class="widget-title">旧ブログ/フォーラム</h3>
  <div class="widget">
    <ul>
      
        <li>
          <a href="../../https:/social.msdn.microsoft.com/Forums/ja-jp/home?forum=visualstudiosupportteamja">Visual Studio サポートチーム フォーラム</a>
        </li>
      
        <li>
          <a href="../../https:/social.msdn.microsoft.com/Forums/ja-jp/home?forum=windowssdksupportteamja&filter=alltypes&sort=lastpostdesc">Windows SDK サポートチーム フォーラム</a>
        </li>
      
        <li>
          <a href="../../https:/docs.microsoft.com/en-us/archive/blogs/jpvsblog/">Visual Studio サポート チーム blog</a>
        </li>
      
        <li>
          <a href="../../https:/docs.microsoft.com/en-us/archive/blogs/japan_platform_sdkwindows_sdk_support_team_blog/">JAPAN Platform SDK（Windows SDK） Support Team Blog</a>
        </li>
      
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title">関連リンク</h3>
  <div class="widget">
    <ul>
      
        <li>
          <a href="../../https:/developercommunity.visualstudio.com/">Developer Community</a>
        </li>
      
        <li>
          <a href="../../https:/devblogs.microsoft.com/dotnet/">.NET Blog</a>
        </li>
      
        <li>
          <a href="../../https:/devblogs.microsoft.com/visualstudio/">Visual Studio Blog</a>
        </li>
      
        <li>
          <a href="../../https:/devblogs.microsoft.com/cppblog/">C++ Team Blog</a>
        </li>
      
        <li>
          <a href="../../https:/devblogs.microsoft.com/xamarin/">Xamarin Blog</a>
        </li>
      
        <li>
          <a href="../../https:/devblogs.microsoft.com/devops/">Azure DevOps Blog</a>
        </li>
      
        <li>
          <a href="../../https:/techcommunity.microsoft.com/t5/azure-lab-services/bg-p/AzureLabServicesBlog/">Azure Lab Services Blog</a>
        </li>
      
        <li>
          <a href="../../https:/devblogs.microsoft.com/appcenter/">App Center Blog</a>
        </li>
      
        <li>
          <a href="../../https:/status.azure.com/status/">Azure Status</a>
        </li>
      
        <li>
          <a href="../../https:/status.dev.azure.com/">Azure DevOps - Status</a>
        </li>
      
    </ul>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Developer Support Core Japan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<script src="../../js/script.js"></script>




  </div>
</body>
</html>